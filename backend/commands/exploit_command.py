from typing import Dict, Any
from commands.base_command import BaseCommand

class ExploitCommand(BaseCommand):
    def execute(self, args: str) -> Dict[str, Any]:
        unlocked_commands = self.session.get("unlocked_commands", [])
        if "EXPLOIT" not in unlocked_commands:
            if self.lang == "FR":
                return {"response": "Commande inconnue. Accès refusé.\n\nTapez HELP pour voir les commandes disponibles.", "status": "error"}
            else:
                return {"response": "Unknown command. Access Denied.\n\nType HELP to see available commands.", "status": "error"}
        
        if not args:
            if self.lang == "FR":
                return {"response": "Usage: EXPLOIT <CVE>\n\nTrouvez un code CVE valide dans les fichiers du systeme...", "status": "info"}
            else:
                return {"response": "Usage: EXPLOIT <CVE>\n\nFind a valid CVE code in the system files...", "status": "info"}
        
        cve = args.upper().strip()
        
        if cve == "CVE-2024-DB-001":
            self.session.setdefault("flags", []).append("exploit_success")
            self.add_solved_puzzle("CVE-2024-DB-001")
            self.add_unlocked_command("CREATE_USER")
            
            if self.lang == "FR":
                return {
                    "response": """Exploit CVE-2024-DB-001 exécuté avec succès!

Vulnérabilité SQL détectée dans la base de données.
Accès non autorisé obtenu.

Vous pouvez maintenant créer un utilisateur avec:
CREATE_USER <username> <password>""",
                    "status": "success",
                    "exploit_success": True
                }
            else:
                return {
                    "response": """Exploit CVE-2024-DB-001 executed successfully!

SQL vulnerability detected in database.
Unauthorized access obtained.

You can now create a user with:
CREATE_USER <username> <password>""",
                    "status": "success",
                    "exploit_success": True
                }
        else:
            if self.lang == "FR":
                return {"response": f"Exploit {cve} non disponible ou invalide.", "status": "error"}
            else:
                return {"response": f"Exploit {cve} not available or invalid.", "status": "error"}

